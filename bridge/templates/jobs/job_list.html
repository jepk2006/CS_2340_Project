{% extends "base.html" %}

{% block extra_head %}
  {{ block.super }}
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    crossorigin=""
  />
{% endblock %}

{% block content %}
<div class="grid grid-cols-1 lg:grid-cols-4 gap-8">
  <aside class="lg:col-span-1 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-800 rounded-xl p-4 h-fit sticky top-24">
    <h2 class="text-lg font-semibold mb-4">Filters</h2>
    
    {% if user.is_authenticated and user.jobseeker_profile.commute_radius %}
    <div class="mb-4 p-3 bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-lg">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-sm font-medium text-blue-900 dark:text-blue-100">Commute Filter Active</p>
          <p class="text-xs text-blue-700 dark:text-blue-300">Showing jobs within {{ user.jobseeker_profile.commute_radius }} miles</p>
        </div>
        <a href="{% url 'accounts:profile_edit' %}" class="text-xs text-blue-600 dark:text-blue-400 hover:underline">Edit</a>
      </div>
    </div>
    {% endif %}
    
    <form method="get" class="space-y-4">
      <div>
        <label class="block mb-1">Title</label>
        <input type="text" name="title" placeholder="e.g. Software Engineer" value="{{ request.GET.title }}" />
      </div>
      <div>
        <label class="block mb-1">Company</label>
        <input type="text" name="company" placeholder="Company" value="{{ request.GET.company }}" />
      </div>
      <div class="grid grid-cols-3 gap-2">
        <div>
          <label class="block mb-1">City</label>
          <input type="text" name="location_city" placeholder="City" value="{{ request.GET.location_city }}" />
        </div>
        <div>
          <label class="block mb-1">State</label>
          <input type="text" name="location_state" placeholder="State" value="{{ request.GET.location_state }}" />
        </div>
        <div>
          <label class="block mb-1">Country</label>
          <input type="text" name="location_country" placeholder="Country" value="{{ request.GET.location_country }}" />
        </div>
      </div>
      <div class="grid grid-cols-2 gap-2">
        <div>
          <label class="block mb-1">Min Salary</label>
          <input type="number" name="min_salary" placeholder="70000" value="{{ request.GET.min_salary }}" />
        </div>
        <div>
          <label class="block mb-1">Max Salary</label>
          <input type="number" name="max_salary" placeholder="120000" value="{{ request.GET.max_salary }}" />
        </div>
      </div>
      <div>
        <label class="block mb-1">Work Type</label>
        <select name="work_type">
          <option value="">Any</option>
          {% for key,label in jobs.model.WorkType.choices %}
            <option value="{{ key }}" {% if request.GET.work_type == key %}selected{% endif %}>{{ label }}</option>
          {% endfor %}
        </select>
      </div>
      <label class="inline-flex items-center gap-2"><input type="checkbox" name="visa_sponsorship" value="true" {% if request.GET.visa_sponsorship %}checked{% endif %}/> Visa sponsorship</label>
      <div class="flex gap-2">
        <button type="submit" class="bg-indigo-600 text-white px-4 py-2 rounded-md hover:bg-indigo-500">Apply</button>
        <a href="/jobs/" class="px-4 py-2 rounded-md border border-gray-300 dark:border-gray-700">Reset</a>
      </div>
    </form>
  </aside>

  <section class="lg:col-span-3 space-y-4" x-data="{ view: 'list' }">
    <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3">
      <div>
        <h1 class="text-2xl font-semibold">Job openings</h1>
        <div class="text-sm text-gray-500">{{ page_obj.paginator.count }} results</div>
      </div>
      <div class="flex items-center gap-2 self-start md:self-auto">
        <span class="text-xs text-gray-500 uppercase tracking-wide">View</span>
        <div class="inline-flex rounded-lg border border-gray-200 dark:border-gray-700 overflow-hidden">
          <button
            type="button"
            data-view-toggle="list"
            class="px-3 py-1.5 text-sm font-medium bg-gray-100 dark:bg-gray-800"
          >List</button>
          <button
            type="button"
            data-view-toggle="map"
            class="px-3 py-1.5 text-sm font-medium"
          >Map</button>
        </div>
      </div>
    </div>
    <div id="mapStatus" class="hidden text-sm text-amber-600 dark:text-amber-400 bg-amber-50 dark:bg-amber-900/20 border border-amber-200 dark:border-amber-700 rounded-lg px-4 py-3"></div>

    <div id="jobListSection" class="grid grid-cols-1 gap-4">
      {% for job in jobs %}
        <a href="{% url 'jobs:job_detail' job.pk %}" class="block border border-gray-200 dark:border-gray-800 rounded-xl p-5 bg-white dark:bg-gray-800 hover:shadow">
          <div class="flex items-start justify-between">
            <div>
              <div class="text-lg font-semibold">{{ job.title }}</div>
              <div class="text-sm text-gray-500">{{ job.company }}</div>
            </div>
            <span class="text-xs rounded-full px-2 py-1 border border-gray-300 dark:border-gray-700">{{ job.get_work_type_display }}</span>
          </div>
          <div class="mt-2 text-sm text-gray-600 dark:text-gray-300 line-clamp-2">{{ job.description }}</div>
          <div class="mt-3 flex flex-wrap gap-2">
            {% for s in job.skills.all %}
              <span class="text-xs bg-indigo-50 dark:bg-indigo-900/30 text-indigo-700 dark:text-indigo-300 px-2 py-1 rounded">{{ s.name }}</span>
            {% empty %}
              <span class="text-xs text-gray-400">No skills listed</span>
            {% endfor %}
          </div>
          <div class="mt-3 text-sm text-gray-500 flex items-center gap-4">
            <span>{{ job.location_city }} {{ job.location_state }} {{ job.location_country }}</span>
            {% if job_distances %}
              {% for job_id, distance in job_distances.items %}
                {% if job_id == job.pk %}
                  <span class="text-blue-600 dark:text-blue-400 font-medium">{{ distance }} miles away</span>
                {% endif %}
              {% endfor %}
            {% endif %}
            <span>
              {% if job.min_salary %}${{ job.min_salary }}{% endif %}
              {% if job.max_salary %}- ${{ job.max_salary }}{% endif %}
            </span>
            <span>Visa: {{ job.visa_sponsorship|yesno:"Yes,No" }}</span>
          </div>
        </a>
      {% empty %}
        <div class="text-center py-8">
          <div class="text-gray-500 mb-4">
            {% if user.is_authenticated and user.jobseeker_profile.commute_radius %}
              No jobs found within your {{ user.jobseeker_profile.commute_radius }}-mile commute radius.
            {% else %}
              No jobs found.
            {% endif %}
          </div>
          {% if user.is_authenticated and not user.jobseeker_profile.commute_radius %}
            <a href="{% url 'accounts:profile_edit' %}" class="text-blue-600 dark:text-blue-400 hover:underline">
              Set your commute radius to see jobs within your preferred distance
            </a>
          {% endif %}
        </div>
      {% endfor %}
    </div>

    <div id="jobMapContainer" class="hidden">
      <div class="mb-3 space-y-2">
        <div class="flex flex-col md:flex-row md:items-center gap-2">
          <div class="flex items-center gap-2">
            <label for="distanceMilesInput" class="text-sm">Max distance (miles)</label>
            <input id="distanceMilesInput" type="number" min="1" step="1" placeholder="e.g. 25" class="w-24" />
          </div>
          <div class="flex items-center gap-2">
            <button id="useLocationBtn" type="button" class="px-3 py-1.5 rounded border border-gray-300 dark:border-gray-700">Use My Location</button>
            <button id="applyDistanceBtn" type="button" class="px-3 py-1.5 rounded bg-indigo-600 text-white">Apply Distance</button>
          </div>
        </div>
        <div class="flex flex-col md:flex-row md:items-center gap-2">
          <div class="text-sm text-gray-600 dark:text-gray-400">Or enter coordinates manually:</div>
          <div class="flex items-center gap-2">
            <input id="manualLatInput" type="number" step="any" placeholder="33.7490" class="w-28 text-sm" title="Latitude (e.g., 33.7490 for Atlanta)" />
            <input id="manualLonInput" type="number" step="any" placeholder="-84.3880" class="w-28 text-sm" title="Longitude (e.g., -84.3880 for Atlanta)" />
            <button id="useManualLocationBtn" type="button" class="px-2 py-1 text-sm rounded border border-gray-300 dark:border-gray-700">Set Location</button>
          </div>
        </div>
        <div class="text-xs text-gray-500 dark:text-gray-400">
          Examples: Atlanta (33.7490, -84.3880), NYC (40.7128, -74.0060), SF (37.7749, -122.4194)
        </div>
      </div>
      <div id="jobMap" class="h-96 rounded-xl overflow-hidden border border-gray-200 dark:border-gray-800"></div>
    </div>

    {% if page_obj.has_other_pages %}
    <div id="paginationControls" class="flex items-center justify-between pt-4">
      <div>
        {% if page_obj.has_previous %}
          <a class="px-3 py-1 rounded border border-gray-300 dark:border-gray-700" href="?page={{ page_obj.previous_page_number }}">Previous</a>
        {% endif %}
      </div>
      <div class="text-sm">Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}</div>
      <div>
        {% if page_obj.has_next %}
          <a class="px-3 py-1 rounded border border-gray-300 dark:border-gray-700" href="?page={{ page_obj.next_page_number }}">Next</a>
        {% endif %}
      </div>
    </div>
    {% endif %}
  </section>
</div>
{% endblock %}

{% block extra_scripts %}
  {{ block.super }}
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    crossorigin=""
  ></script>
  <script>
    (function() {
      const listToggle = document.querySelector('[data-view-toggle="list"]');
      const mapToggle = document.querySelector('[data-view-toggle="map"]');
      const jobListSection = document.getElementById('jobListSection');
      const paginationControls = document.getElementById('paginationControls');
      const mapContainer = document.getElementById('jobMapContainer');
      const mapStatus = document.getElementById('mapStatus');
      const mapElement = document.getElementById('jobMap');
      let mapInstance = null;
      let markersLayer = null;
      let hasLoaded = false;
      let userLat = null;
      let userLon = null;
      let distanceMiles = null;

      const distanceInput = document.getElementById('distanceMilesInput');
      const useLocationBtn = document.getElementById('useLocationBtn');
      const applyDistanceBtn = document.getElementById('applyDistanceBtn');
      const manualLatInput = document.getElementById('manualLatInput');
      const manualLonInput = document.getElementById('manualLonInput');
      const useManualLocationBtn = document.getElementById('useManualLocationBtn');

      if (!listToggle || !mapToggle || !jobListSection || !mapContainer) {
        return;
      }

      function setActiveButton(activeButton) {
        [listToggle, mapToggle].forEach((btn) => {
          if (btn === activeButton) {
            btn.classList.add('bg-gray-100', 'dark:bg-gray-800');
          } else {
            btn.classList.remove('bg-gray-100', 'dark:bg-gray-800');
          }
        });
      }

      function showListView() {
        setActiveButton(listToggle);
        jobListSection.classList.remove('hidden');
        mapContainer.classList.add('hidden');
        paginationControls?.classList.remove('hidden');
        mapStatus.classList.add('hidden');
      }

      function showMapView() {
        setActiveButton(mapToggle);
        jobListSection.classList.add('hidden');
        mapContainer.classList.remove('hidden');
        paginationControls?.classList.add('hidden');
        if (!hasLoaded) {
          initializeMap();
        } else if (mapInstance) {
          setTimeout(() => {
            mapInstance.invalidateSize();
          }, 0);
        }
      }

      function getMapUrl() {
        const url = new URL(window.location.origin + '/jobs/map-data/');
        const params = new URLSearchParams(window.location.search);
        params.forEach((value, key) => url.searchParams.append(key, value));
        if (userLat != null && userLon != null) {
          url.searchParams.set('user_lat', String(userLat));
          url.searchParams.set('user_lon', String(userLon));
        }
        const rawMiles = distanceInput?.value || '';
        const miles = rawMiles ? parseFloat(rawMiles) : distanceMiles;
        if (miles && !Number.isNaN(miles) && miles > 0) {
          url.searchParams.set('max_distance', String(miles));
        }
        return url.toString();
      }

      function initializeMap() {
        fetch(getMapUrl())
          .then((response) => {
            if (!response.ok) {
              throw new Error('Failed to load map data');
            }
            return response.json();
          })
          .then((data) => {
            if (!mapInstance) {
              mapInstance = L.map(mapElement).setView([20, 0], 2);
              L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19,
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
              }).addTo(mapInstance);
            }

            if (markersLayer) {
              markersLayer.clearLayers();
            } else {
              markersLayer = L.layerGroup().addTo(mapInstance);
            }

            const bounds = [];

            data.results.forEach((job) => {
              const marker = L.marker([job.latitude, job.longitude]).bindPopup(
                `<div class="space-y-1">
                  <div class="font-semibold">${job.title}</div>
                  <div class="text-sm text-gray-600">${job.company}</div>
                  ${job.location ? `<div class="text-xs text-gray-500">${job.location}</div>` : ''}
                  ${job.distance_miles ? `<div class="text-xs text-indigo-600">${job.distance_miles} miles away</div>` : ''}
                  ${job.salary_range ? `<div class="text-xs text-gray-500">${job.salary_range}</div>` : ''}
                  <a href="${job.detail_url}" class="text-indigo-600 text-xs font-medium">View details</a>
                </div>`
              );
              marker.addTo(markersLayer);
              bounds.push([job.latitude, job.longitude]);
            });

            if (data.user_location) {
              const userMarker = L.circleMarker([
                data.user_location.latitude,
                data.user_location.longitude,
              ], {
                color: '#4f46e5',
                radius: 8,
                fillOpacity: 0.7,
              }).bindPopup('Your location');
              userMarker.addTo(markersLayer);
              bounds.push([data.user_location.latitude, data.user_location.longitude]);
            }

            if (bounds.length) {
              mapInstance.fitBounds(bounds, { padding: [30, 30] });
            }

            hasLoaded = true;

            if (data.missing_count > 0) {
              mapStatus.textContent = `${data.missing_count} job${data.missing_count === 1 ? '' : 's'} missing map coordinates were excluded.`;
              mapStatus.classList.remove('hidden');
            } else {
              mapStatus.classList.add('hidden');
            }

            if (!data.results.length) {
              mapStatus.textContent = 'No jobs with map coordinates match your filters.';
              mapStatus.classList.remove('hidden');
            }

            setTimeout(() => {
              mapInstance.invalidateSize();
            }, 100);
          })
          .catch((error) => {
            console.error(error);
            mapStatus.textContent = 'There was an error loading the map view. Please try again later.';
            mapStatus.classList.remove('hidden');
          });
      }

      function updateMapData() {
        if (!mapInstance) {
          initializeMap();
          return;
        }
        fetch(getMapUrl())
          .then((response) => {
            if (!response.ok) throw new Error('Failed to load map data');
            return response.json();
          })
          .then((data) => {
            if (markersLayer) {
              markersLayer.clearLayers();
            } else {
              markersLayer = L.layerGroup().addTo(mapInstance);
            }

            const bounds = [];
            data.results.forEach((job) => {
              const marker = L.marker([job.latitude, job.longitude]).bindPopup(
                `<div class="space-y-1">
                  <div class="font-semibold">${job.title}</div>
                  <div class="text-sm text-gray-600">${job.company}</div>
                  ${job.location ? `<div class="text-xs text-gray-500">${job.location}</div>` : ''}
                  ${job.distance_miles ? `<div class="text-xs text-indigo-600">${job.distance_miles} miles away</div>` : ''}
                  ${job.salary_range ? `<div class="text-xs text-gray-500">${job.salary_range}</div>` : ''}
                  <a href="${job.detail_url}" class="text-indigo-600 text-xs font-medium">View details</a>
                </div>`
              );
              marker.addTo(markersLayer);
              bounds.push([job.latitude, job.longitude]);
            });

            if (data.user_location) {
              const userMarker = L.circleMarker([
                data.user_location.latitude,
                data.user_location.longitude,
              ], {
                color: '#4f46e5',
                radius: 8,
                fillOpacity: 0.7,
              }).bindPopup('Your location');
              userMarker.addTo(markersLayer);
              bounds.push([data.user_location.latitude, data.user_location.longitude]);
            }

            if (bounds.length) {
              mapInstance.fitBounds(bounds, { padding: [30, 30] });
            }

            if (data.missing_count > 0) {
              mapStatus.textContent = `${data.missing_count} job${data.missing_count === 1 ? '' : 's'} missing map coordinates were excluded.`;
              mapStatus.classList.remove('hidden');
            } else {
              mapStatus.classList.add('hidden');
            }

            if (!data.results.length) {
              mapStatus.textContent = 'No jobs with map coordinates match your filters.';
              mapStatus.classList.remove('hidden');
            }
          })
          .catch((error) => {
            console.error(error);
            mapStatus.textContent = 'There was an error loading the map view. Please try again later.';
            mapStatus.classList.remove('hidden');
          });
      }

      // Prefill from URL if present
      (function prefillDistanceFromQuery() {
        const params = new URLSearchParams(window.location.search);
        const existing = params.get('max_distance');
        if (existing && distanceInput) {
          distanceInput.value = existing;
        }
      })();

      if (useLocationBtn) {
        useLocationBtn.addEventListener('click', () => {
          if (!navigator.geolocation) {
            mapStatus.textContent = 'Geolocation is not supported by your browser.';
            mapStatus.classList.remove('hidden');
            return;
          }

          // Show loading state
          useLocationBtn.disabled = true;
          useLocationBtn.textContent = 'Getting location...';
          mapStatus.textContent = 'Requesting your location...';
          mapStatus.classList.remove('hidden');

          navigator.geolocation.getCurrentPosition(
            (pos) => {
              userLat = pos.coords.latitude;
              userLon = pos.coords.longitude;
              console.log('Location obtained:', userLat, userLon);
              
              // Reset button state
              useLocationBtn.disabled = false;
              useLocationBtn.textContent = 'Use My Location';
              
              mapStatus.textContent = `Location set: ${userLat.toFixed(4)}, ${userLon.toFixed(4)}`;
              mapStatus.classList.remove('hidden');
              
              // Update map with new location
              updateMapData();
            },
            (err) => {
              console.error('Geolocation error:', err);
              
              // Reset button state
              useLocationBtn.disabled = false;
              useLocationBtn.textContent = 'Use My Location';
              
              let errorMessage = 'Could not get your location. ';
              switch(err.code) {
                case err.PERMISSION_DENIED:
                  errorMessage += 'Please allow location access in your browser settings and try again.';
                  break;
                case err.POSITION_UNAVAILABLE:
                  errorMessage += 'Location information is unavailable.';
                  break;
                case err.TIMEOUT:
                  errorMessage += 'Location request timed out. Please try again.';
                  break;
                default:
                  errorMessage += 'An unknown error occurred.';
                  break;
              }
              
              mapStatus.textContent = errorMessage;
              mapStatus.classList.remove('hidden');
            },
            { 
              enableHighAccuracy: true, 
              timeout: 15000, 
              maximumAge: 300000 // 5 minutes
            }
          );
        });
      }

      if (applyDistanceBtn) {
        applyDistanceBtn.addEventListener('click', () => {
          const raw = distanceInput?.value || '';
          const miles = raw ? parseFloat(raw) : null;
          distanceMiles = miles && !Number.isNaN(miles) && miles > 0 ? miles : null;
          updateMapData();
        });
      }

      if (useManualLocationBtn) {
        useManualLocationBtn.addEventListener('click', () => {
          const lat = parseFloat(manualLatInput?.value || '');
          const lon = parseFloat(manualLonInput?.value || '');
          
          if (isNaN(lat) || isNaN(lon)) {
            mapStatus.textContent = 'Please enter valid latitude and longitude values.';
            mapStatus.classList.remove('hidden');
            return;
          }
          
          if (lat < -90 || lat > 90) {
            mapStatus.textContent = 'Latitude must be between -90 and 90.';
            mapStatus.classList.remove('hidden');
            return;
          }
          
          if (lon < -180 || lon > 180) {
            mapStatus.textContent = 'Longitude must be between -180 and 180.';
            mapStatus.classList.remove('hidden');
            return;
          }
          
          userLat = lat;
          userLon = lon;
          console.log('Manual location set:', userLat, userLon);
          
          mapStatus.textContent = `Manual location set: ${userLat.toFixed(4)}, ${userLon.toFixed(4)}`;
          mapStatus.classList.remove('hidden');
          
          updateMapData();
        });
      }

      listToggle.addEventListener('click', showListView);
      mapToggle.addEventListener('click', showMapView);
      showListView();
    })();
  </script>
{% endblock %}