{% extends "base.html" %}

{% block extra_head %}
  {{ block.super }}
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    crossorigin=""
  />
{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto">
  <div class="bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-800 rounded-xl p-6">
    <div class="mb-6">
      <h1 class="text-2xl font-semibold">{{ form_title }}</h1>
      <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">Fill in the details to {{ submit_text|lower }}</p>
    </div>

    <form method="post" class="space-y-6">
      {% csrf_token %}
      
      {% if form.non_field_errors %}
        <div class="rounded-md border border-red-300 dark:border-red-700 bg-red-50 dark:bg-red-900/20 px-4 py-3 text-sm text-red-800 dark:text-red-200">
          {{ form.non_field_errors }}
        </div>
      {% endif %}

      <!-- Basic Information -->
      <div class="space-y-4">
        <h2 class="text-lg font-medium border-b border-gray-200 dark:border-gray-700 pb-2">Basic Information</h2>
        
        <div>
          <label for="{{ form.title.id_for_label }}" class="block mb-1 font-medium">Job Title *</label>
          {{ form.title }}
          {% if form.title.errors %}
            <p class="text-xs text-red-600 dark:text-red-400 mt-1">{{ form.title.errors.0 }}</p>
          {% endif %}
        </div>

        <div>
          <label for="{{ form.company.id_for_label }}" class="block mb-1 font-medium">Company *</label>
          {{ form.company }}
          {% if form.company.errors %}
            <p class="text-xs text-red-600 dark:text-red-400 mt-1">{{ form.company.errors.0 }}</p>
          {% endif %}
        </div>

        <div>
          <label for="{{ form.description.id_for_label }}" class="block mb-1 font-medium">Job Description *</label>
          {{ form.description }}
          {% if form.description.errors %}
            <p class="text-xs text-red-600 dark:text-red-400 mt-1">{{ form.description.errors.0 }}</p>
          {% endif %}
          <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Describe the role, responsibilities, and requirements</p>
        </div>
      </div>

      <!-- Skills -->
      <div class="space-y-4">
        <h2 class="text-lg font-medium border-b border-gray-200 dark:border-gray-700 pb-2">Required Skills</h2>
        
        <div class="grid grid-cols-2 md:grid-cols-3 gap-3">
          {% for checkbox in form.skills %}
            <label class="inline-flex items-center gap-2 cursor-pointer">
              {{ checkbox.tag }}
              <span class="text-sm">{{ checkbox.choice_label }}</span>
            </label>
          {% endfor %}
        </div>
        {% if form.skills.errors %}
          <p class="text-xs text-red-600 dark:text-red-400">{{ form.skills.errors.0 }}</p>
        {% endif %}
        
        <div class="mt-4">
          <label for="{{ form.other_skills.id_for_label }}" class="block mb-1 font-medium">Add Custom Skills</label>
          {{ form.other_skills }}
          {% if form.other_skills.errors %}
            <p class="text-xs text-red-600 dark:text-red-400 mt-1">{{ form.other_skills.errors.0 }}</p>
          {% endif %}
          {% if form.other_skills.help_text %}
            <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">{{ form.other_skills.help_text }}</p>
          {% endif %}
        </div>
      </div>

      <!-- Location -->
      <div class="space-y-4">
        <h2 class="text-lg font-medium border-b border-gray-200 dark:border-gray-700 pb-2">Location</h2>
        
        <div class="grid grid-cols-3 gap-4">
          <div>
            <label for="{{ form.location_city.id_for_label }}" class="block mb-1 font-medium">City</label>
            {{ form.location_city }}
            {% if form.location_city.errors %}
              <p class="text-xs text-red-600 dark:text-red-400 mt-1">{{ form.location_city.errors.0 }}</p>
            {% endif %}
          </div>

          <div>
            <label for="{{ form.location_state.id_for_label }}" class="block mb-1 font-medium">State</label>
            {{ form.location_state }}
            {% if form.location_state.errors %}
              <p class="text-xs text-red-600 dark:text-red-400 mt-1">{{ form.location_state.errors.0 }}</p>
            {% endif %}
          </div>

          <div>
            <label for="{{ form.location_country.id_for_label }}" class="block mb-1 font-medium">Country</label>
            {{ form.location_country }}
            {% if form.location_country.errors %}
              <p class="text-xs text-red-600 dark:text-red-400 mt-1">{{ form.location_country.errors.0 }}</p>
            {% endif %}
          </div>
        </div>

        <!-- Hidden latitude/longitude fields (auto-populated by map) -->
        <div style="display: none;">
          {{ form.latitude }}
          {{ form.longitude }}
        </div>

        <!-- Geocoding Button -->
        <div class="flex items-center gap-3">
          <button type="button" id="geocodeBtn" class="bg-indigo-600 text-white px-4 py-2 rounded-md hover:bg-indigo-500 font-medium">
            üìç Find Location on Map
          </button>
          <button type="button" id="clearLocationBtn" class="px-4 py-2 rounded-md border border-gray-300 dark:border-gray-700 hover:bg-gray-100 dark:hover:bg-gray-700">
            Clear Location
          </button>
          <span id="geocodeStatus" class="text-sm text-gray-500"></span>
        </div>

        <!-- Map Container -->
        <div class="space-y-2">
          <p class="text-sm text-gray-600 dark:text-gray-400">
            Click on the map to pin the exact office location, or use "Find Location on Map" to geocode the address above.
          </p>
          <div id="jobLocationMap" class="h-96 rounded-xl overflow-hidden border border-gray-200 dark:border-gray-800"></div>
        </div>

        <!-- Current Coordinates Display -->
        <div id="coordsDisplay" class="text-sm text-gray-600 dark:text-gray-400 hidden">
          <span class="font-medium">Selected Location:</span>
          <span id="coordsText"></span>
        </div>
      </div>

      <!-- Compensation & Work Details -->
      <div class="space-y-4">
        <h2 class="text-lg font-medium border-b border-gray-200 dark:border-gray-700 pb-2">Compensation & Work Details</h2>
        
        <div class="grid grid-cols-2 gap-4">
          <div>
            <label for="{{ form.min_salary.id_for_label }}" class="block mb-1 font-medium">Min Salary ($)</label>
            {{ form.min_salary }}
            {% if form.min_salary.errors %}
              <p class="text-xs text-red-600 dark:text-red-400 mt-1">{{ form.min_salary.errors.0 }}</p>
            {% endif %}
          </div>

          <div>
            <label for="{{ form.max_salary.id_for_label }}" class="block mb-1 font-medium">Max Salary ($)</label>
            {{ form.max_salary }}
            {% if form.max_salary.errors %}
              <p class="text-xs text-red-600 dark:text-red-400 mt-1">{{ form.max_salary.errors.0 }}</p>
            {% endif %}
          </div>
        </div>

        <div>
          <label for="{{ form.work_type.id_for_label }}" class="block mb-1 font-medium">Work Type *</label>
          {{ form.work_type }}
          {% if form.work_type.errors %}
            <p class="text-xs text-red-600 dark:text-red-400 mt-1">{{ form.work_type.errors.0 }}</p>
          {% endif %}
        </div>

        <div>
          <label class="inline-flex items-center gap-2 cursor-pointer">
            {{ form.visa_sponsorship }}
            <span class="font-medium">Offers Visa Sponsorship</span>
          </label>
          {% if form.visa_sponsorship.errors %}
            <p class="text-xs text-red-600 dark:text-red-400 mt-1">{{ form.visa_sponsorship.errors.0 }}</p>
          {% endif %}
        </div>
      </div>

      <!-- Submit Buttons -->
      <div class="flex items-center gap-3 pt-4 border-t border-gray-200 dark:border-gray-700">
        <button type="submit" class="bg-indigo-600 text-white px-6 py-2 rounded-md hover:bg-indigo-500 font-medium">
          {{ submit_text }}
        </button>
        <a href="{% if is_edit %}{% url 'jobs:job_detail' object.pk %}{% else %}{% url 'jobs:my_jobs' %}{% endif %}" 
           class="px-6 py-2 rounded-md border border-gray-300 dark:border-gray-700 hover:bg-gray-100 dark:hover:bg-gray-700">
          Cancel
        </a>
      </div>
    </form>
  </div>
</div>
{% endblock %}

{% block extra_scripts %}
  {{ block.super }}
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    crossorigin=""
  ></script>
  <script>
    (function() {
      // Get form elements
      const cityInput = document.getElementById('{{ form.location_city.id_for_label }}');
      const stateInput = document.getElementById('{{ form.location_state.id_for_label }}');
      const countryInput = document.getElementById('{{ form.location_country.id_for_label }}');
      const latInput = document.getElementById('{{ form.latitude.id_for_label }}');
      const lonInput = document.getElementById('{{ form.longitude.id_for_label }}');
      const geocodeBtn = document.getElementById('geocodeBtn');
      const clearLocationBtn = document.getElementById('clearLocationBtn');
      const geocodeStatus = document.getElementById('geocodeStatus');
      const coordsDisplay = document.getElementById('coordsDisplay');
      const coordsText = document.getElementById('coordsText');
      const mapElement = document.getElementById('jobLocationMap');

      // Initialize map - centered on US by default
      const map = L.map(mapElement).setView([39.8283, -98.5795], 4);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
      }).addTo(map);

      let marker = null;

      // Function to update coordinates and display
      function updateCoordinates(lat, lon) {
        latInput.value = lat.toFixed(6);
        lonInput.value = lon.toFixed(6);
        coordsText.textContent = `Latitude: ${lat.toFixed(6)}, Longitude: ${lon.toFixed(6)}`;
        coordsDisplay.classList.remove('hidden');
      }

      // Function to place marker on map
      function placeMarker(lat, lon) {
        if (marker) {
          marker.setLatLng([lat, lon]);
        } else {
          marker = L.marker([lat, lon], { draggable: true }).addTo(map);
          
          // Update coordinates when marker is dragged
          marker.on('dragend', function(e) {
            const pos = e.target.getLatLng();
            updateCoordinates(pos.lat, pos.lng);
          });
        }
        map.setView([lat, lon], 13);
        updateCoordinates(lat, lon);
      }

      // Geocode address using Nominatim (OpenStreetMap)
      async function geocodeAddress() {
        const city = cityInput.value.trim();
        const state = stateInput.value.trim();
        const country = countryInput.value.trim();

        if (!city && !state && !country) {
          geocodeStatus.textContent = 'Please enter at least a city, state, or country.';
          geocodeStatus.className = 'text-sm text-red-600 dark:text-red-400';
          return;
        }

        geocodeStatus.textContent = 'Searching for location...';
        geocodeStatus.className = 'text-sm text-blue-600 dark:text-blue-400';

        // Build query string
        const queryParts = [];
        if (city) queryParts.push(city);
        if (state) queryParts.push(state);
        if (country) queryParts.push(country);
        const query = queryParts.join(', ');

        try {
          const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=1`);
          const data = await response.json();

          if (data && data.length > 0) {
            const lat = parseFloat(data[0].lat);
            const lon = parseFloat(data[0].lon);
            placeMarker(lat, lon);
            geocodeStatus.textContent = '‚úì Location found!';
            geocodeStatus.className = 'text-sm text-green-600 dark:text-green-400';
          } else {
            geocodeStatus.textContent = 'Location not found. Try clicking on the map instead.';
            geocodeStatus.className = 'text-sm text-red-600 dark:text-red-400';
          }
        } catch (error) {
          console.error('Geocoding error:', error);
          geocodeStatus.textContent = 'Error finding location. Please try again.';
          geocodeStatus.className = 'text-sm text-red-600 dark:text-red-400';
        }
      }

      // Clear location
      function clearLocation() {
        if (marker) {
          map.removeLayer(marker);
          marker = null;
        }
        latInput.value = '';
        lonInput.value = '';
        coordsDisplay.classList.add('hidden');
        geocodeStatus.textContent = '';
      }

      // Map click event - place marker
      map.on('click', function(e) {
        placeMarker(e.latlng.lat, e.latlng.lng);
        geocodeStatus.textContent = '‚úì Location pinned!';
        geocodeStatus.className = 'text-sm text-green-600 dark:text-green-400';
      });

      // Button events
      geocodeBtn.addEventListener('click', geocodeAddress);
      clearLocationBtn.addEventListener('click', clearLocation);

      // Pre-populate map if editing with existing coordinates
      (function initializeExistingLocation() {
        const existingLat = latInput.value;
        const existingLon = lonInput.value;
        
        if (existingLat && existingLon) {
          const lat = parseFloat(existingLat);
          const lon = parseFloat(existingLon);
          
          if (!isNaN(lat) && !isNaN(lon)) {
            placeMarker(lat, lon);
            geocodeStatus.textContent = '‚úì Existing location loaded';
            geocodeStatus.className = 'text-sm text-green-600 dark:text-green-400';
          }
        }
      })();
    })();
  </script>
{% endblock %}
